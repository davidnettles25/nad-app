<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAD Test Admin Dashboard</title>
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="shared/css/variables.css">
    <link rel="stylesheet" href="shared/css/base.css">
    <link rel="stylesheet" href="shared/css/components.css">
    
    <!-- Admin-specific CSS -->
    <link rel="stylesheet" href="admin/css/admin-dashboard.css">
    <link rel="stylesheet" href="admin/css/sections.css">
    <link rel="stylesheet" href="admin/css/tables.css">
    
    <!-- Shared JavaScript -->
    <script defer src="shared/js/core.js"></script>
    <script defer src="shared/js/api-client.js"></script>
    <script defer src="shared/js/utils.js"></script>
    <script defer src="shared/js/components.js"></script>
    
    <!-- Admin JavaScript -->
    <script defer src="admin/js/admin-dashboard.js"></script>
    <script defer src="admin/js/navigation.js"></script>
    <script defer src="admin/js/data-management.js"></script>
    
    <!-- Section-specific JavaScript -->
    <script defer src="admin/js/sections/tests.js"></script>
    <script defer src="admin/js/sections/users.js"></script>
    <script defer src="admin/js/sections/supplements.js"></script>
    <script defer src="admin/js/sections/analytics.js"></script>
    <script defer src="admin/js/sections/system.js"></script>
</head>
<body>
    <!-- Loading indicator -->
    <div id="nad-loading" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(255,255,255,0.9); z-index: 9999; 
        display: flex; align-items: center; justify-content: center;
        flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
        <div style="
            width: 40px; height: 40px; border: 4px solid #f3f3f3; 
            border-top: 4px solid #667eea; border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 20px;
        "></div>
        <p style="color: #333; font-size: 16px;">Loading NAD Admin Dashboard...</p>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Basic admin layout styles */
        .admin-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .main-content {
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Ensure components are visible */
        #nad-sidebar, #nad-header, #nad-alerts, 
        [id^="nad-"] {
            opacity: 1;
            visibility: visible;
        }
    </style>

    <div class="admin-container" style="display: none;">
        <!-- Sidebar Navigation -->
        <div id="nad-sidebar" data-nad-component="admin/components/sidebar.html"></div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header -->
            <div id="nad-header" data-nad-component="admin/components/header.html"></div>
            
            <!-- Alert System -->
            <div id="nad-alerts" data-nad-component="shared/components/alert-system.html"></div>
            
            <!-- Content Sections -->
            <div id="nad-overview" data-nad-component="admin/sections/overview.html" class="content-section active"></div>
            <div id="nad-tests" data-nad-component="admin/sections/tests.html" class="content-section"></div>
            <div id="nad-users" data-nad-component="admin/sections/users.html" class="content-section"></div>
            <div id="nad-supplements" data-nad-component="admin/sections/supplements.html" class="content-section"></div>
            <div id="nad-analytics" data-nad-component="admin/sections/analytics.html" class="content-section"></div>
            <div id="nad-system" data-nad-component="admin/sections/system.html" class="content-section"></div>
        </div>
    </div>

    <!-- Fallback Error Display -->
    <div id="nad-error" style="display: none; text-align: center; padding: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        <h2 style="color: #dc3545;">‚ö†Ô∏è Dashboard Loading Error</h2>
        <p style="color: #666; margin-bottom: 20px;">Unable to load the modular admin dashboard.</p>
        <button onclick="window.location.href='/nad-app/admin-dashboard.html'" 
                style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            Use Legacy Dashboard
        </button>
        <br><br>
        <button onclick="location.reload()" 
                style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
            Retry Loading
        </button>
    </div>

    <!-- Initialization Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ NAD Admin Dashboard Loading...');
            console.log('üìä Available objects:', {
                NADComponentLoader: typeof window.NADComponentLoader,
                NADComponents: typeof window.NADComponents,
                loadComponent: typeof window.loadComponent
            });
            
            // Set a shorter timeout for debugging
            const loadingTimeout = setTimeout(() => {
                console.warn('‚ö†Ô∏è Loading timeout reached, showing error');
                showError('Loading timeout - components took too long to load');
            }, 5000);
            
            // Check if any component loader is available
            if (typeof window.NADComponentLoader === 'undefined' && typeof window.NADComponents === 'undefined') {
                console.warn('‚ö†Ô∏è No component loader available, redirecting to legacy dashboard');
                clearTimeout(loadingTimeout);
                window.location.href = '/admin-dashboard.html';
                return;
            }
            
            console.log('‚úÖ Component loader found, checking for components...');
            
            // Manual check of component elements
            const componentElements = document.querySelectorAll('[data-nad-component]');
            console.log('üìä Found component elements:', componentElements.length);
            componentElements.forEach((el, i) => {
                console.log(`   ${i+1}. ${el.id} -> ${el.getAttribute('data-nad-component')}`);
            });
            
            // Wait for components to load, then show dashboard
            let checkCount = 0;
            function checkComponentsLoaded() {
                checkCount++;
                console.log(`üîç Check #${checkCount}: Looking for component content...`);
                
                // Check if key components have content
                const sidebar = document.getElementById('nad-sidebar');
                const header = document.getElementById('nad-header');
                
                console.log('üìä Component status:', {
                    sidebar: sidebar ? sidebar.innerHTML.length : 'null',
                    header: header ? header.innerHTML.length : 'null'
                });
                
                if (sidebar && sidebar.innerHTML.trim().length > 50 && header && header.innerHTML.trim().length > 50) {
                    console.log('‚úÖ Components loaded successfully');
                    clearTimeout(loadingTimeout);
                    hideLoading();
                } else if (checkCount > 20) {
                    console.error('‚ùå Gave up waiting for components after 20 checks');
                    showError('Components never loaded content');
                } else {
                    // Check again in 250ms
                    setTimeout(checkComponentsLoaded, 250);
                }
            }
            
            // Start checking immediately, then every 250ms
            checkComponentsLoaded();
            
            function hideLoading() {
                try {
                    document.getElementById('nad-loading').style.display = 'none';
                    document.querySelector('.admin-container').style.display = 'grid';
                    console.log('üéâ NAD Admin Dashboard Ready!');
                    
                    // Initialize any admin dashboard functionality
                    if (typeof window.initializeAdminDashboard === 'function') {
                        window.initializeAdminDashboard();
                        console.log('‚úÖ Admin dashboard initialized');
                    } else {
                        console.log('‚ÑπÔ∏è No initializeAdminDashboard function found');
                    }
                } catch (error) {
                    console.error('‚ùå Error showing dashboard:', error);
                    showError('Error displaying dashboard: ' + error.message);
                }
            }
            
            function showError(message) {
                console.error('‚ùå Dashboard error:', message);
                document.getElementById('nad-loading').style.display = 'none';
                document.querySelector('.admin-container').style.display = 'none';
                document.getElementById('nad-error').style.display = 'block';
            }
            
            // Add manual test button for debugging
            window.debugComponents = function() {
                console.log('üîß Manual component test:');
                if (window.NADComponents && window.NADComponents.loadComponent) {
                    window.NADComponents.loadComponent('admin/components/sidebar.html')
                        .then(html => {
                            console.log('‚úÖ Manual load successful:', html.substring(0, 100) + '...');
                            document.getElementById('nad-sidebar').innerHTML = html;
                        })
                        .catch(err => console.error('‚ùå Manual load failed:', err));
                }
            };
            
            console.log('‚ÑπÔ∏è Debug: Run debugComponents() in console to test manual loading');
        });
    </script>
</body>
</html>
