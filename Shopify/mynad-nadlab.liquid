<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .portal-container {
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    .portal-title {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 28px;
    }
    .portal-description {
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
        line-height: 1.5;
    }
    .portal-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 5px;
        cursor: pointer;
        transition: transform 0.2s;
        margin: 10px;
    }
    .portal-button:hover {
        transform: translateY(-2px);
    }
    .portal-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    .status-message {
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        display: none;
    }
    .status-processing {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }
    .status-error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }
    .status-success {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }
    .access-denied {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ffcc02;
        padding: 20px;
        border-radius: 5px;
        margin-top: 20px;
    }
</style>

<div class="portal-container">
   <h1 class="portal-title">🧪 NAD+ Lab Portal</h1>
   <p class="portal-description">
      Access the NAD+ laboratory interface to manage test results, 
      review quality control data, and process customer test submissions.
   </p>
   
   <button id="labPortalBtn" class="portal-button" onclick="initiateLabPortalAccess()">
      Go to Lab Portal
   </button>
   
   <div id="statusMessage" class="status-message"></div>
   <div id="accessDenied" class="access-denied" style="display: none;">
      <strong>Access Denied:</strong> You do not have the required lab technician role to access this portal.
      Please contact your administrator if you believe this is an error.
   </div>
</div>

<script>
   // Get customer data from Shopify
   const customerData = {
      id: '{{ customer.id }}',
      email: '{{ customer.email }}',
      firstName: '{{ customer.first_name }}',
      lastName: '{{ customer.last_name }}'
   };

   console.log('🔬 Lab Portal initialized for:', customerData.email);

   let pollingInterval;
   let pollingAttempts = 0;
   const maxPollingAttempts = 30; // 30 attempts over ~30 seconds

   function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = `status-message status-${type}`;
      statusDiv.style.display = 'block';
   }

   function hideStatus() {
      document.getElementById('statusMessage').style.display = 'none';
   }

   function showAccessDenied() {
      document.getElementById('accessDenied').style.display = 'block';
      document.getElementById('labPortalBtn').disabled = true;
   }

   function generateSessionId() {
      return 'lab_session_' + Math.random().toString(36).substr(2, 9) + '_' + Math.random().toString(36).substr(2, 8);
   }

   async function initiateLabPortalAccess() {
      if (!customerData.id || !customerData.email) {
            showStatus('Error: Customer data not available. Please log in to your account.', 'error');
            return;
      }

      console.log('🚀 Initiating lab portal access...');
      
      const sessionId = generateSessionId();
      const button = document.getElementById('labPortalBtn');
      
      button.disabled = true;
      hideStatus();
      showStatus('Validating lab access permissions...', 'processing');

      try {
            // Setup lab portal session
            const setupUrl = `https://mynadtest.info/shopify/check-lab-admin-access?session=${sessionId}&setup=true&customerId=${customerData.id}&email=${encodeURIComponent(customerData.email)}&portalType=lab`;
            
            console.log('📡 Setting up lab portal session...');
            const setupResponse = await fetch(setupUrl);
            const setupResult = await setupResponse.json();
            
            if (setupResult.error && setupResult.error.includes('Access denied')) {
               console.log('❌ Lab access denied:', setupResult.error);
               showAccessDenied();
               hideStatus();
               return;
            }
            
            if (setupResult.processing) {
               console.log('✅ Lab portal session created, starting polling...');
               showStatus('Processing lab portal access...', 'processing');
               startPolling(sessionId);
            } else {
               throw new Error(setupResult.error || 'Failed to create lab portal session');
            }
            
      } catch (error) {
            console.error('❌ Lab portal setup failed:', error);
            showStatus('Failed to setup lab portal access. Please try again.', 'error');
            button.disabled = false;
      }
   }

   function startPolling(sessionId) {
      pollingAttempts = 0;
      
      pollingInterval = setInterval(async () => {
            pollingAttempts++;
            console.log(`🔍 Lab polling attempt ${pollingAttempts}/${maxPollingAttempts} for session: ${sessionId}`);
            
            if (pollingAttempts > maxPollingAttempts) {
               clearInterval(pollingInterval);
               showStatus('Lab portal access timed out. Please try again.', 'error');
               document.getElementById('labPortalBtn').disabled = false;
               return;
            }
            
            try {
               const response = await fetch(`https://mynadtest.info/shopify/check-lab-admin-access?session=${sessionId}`);
               const result = await response.json();
               
               console.log('📡 Lab polling response:', result);
               
               if (result.ready && result.portalUrl) {
                  clearInterval(pollingInterval);
                  console.log('✅ Lab portal ready, redirecting to:', result.portalUrl);
                  showStatus('Lab portal access granted! Redirecting...', 'success');
                  
                  setTimeout(() => {
                        window.location.href = result.portalUrl;
                  }, 1000);
                  
               } else if (result.error) {
                  clearInterval(pollingInterval);
                  console.log('❌ Lab portal access error:', result.error);
                  
                  if (result.error.includes('Access denied')) {
                        showAccessDenied();
                        hideStatus();
                  } else {
                        showStatus('Lab portal access failed: ' + result.error, 'error');
                        document.getElementById('labPortalBtn').disabled = false;
                  }
               }
               // Continue polling if still processing
               
            } catch (error) {
               console.error('❌ Lab polling error:', error);
               // Don't stop polling on network errors, just continue
            }
      }, 1000);
   }

   // Initialize on page load
   document.addEventListener('DOMContentLoaded', () => {
      console.log('🔬 NAD+ Lab Portal page loaded');
      
      if (!customerData.id || customerData.id === '') {
            showStatus('Please log in to your account to access the lab portal.', 'error');
            document.getElementById('labPortalBtn').disabled = true;
      }
   });
</script>

{% schema %}
   {
   "name": "NAD Lab",
   "tag": "section",
   "class": "section-nad-lab",
   "presets": [
      {
         "name": "NAD Lab",
         "category": "Custom"
      }
   ]
   }
{% endschema %}